<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spark Ad Studio â€” Uygulama</title>
  <meta name="description" content="Spark Ad Studio: fikir yaz, reklam metni Ã¼ret. (Demo) Paketler, ÅŸablonlar, geÃ§miÅŸ, export." />
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --muted:rgba(255,255,255,.72);
      --border:rgba(255,255,255,.12);
      --r:16px;
      --sh:0 14px 32px rgba(0,0,0,.35);
      --free1:#3b82f6; --free2:#22c55e;
      --inf1:#c026d3; --inf2:#ec4899;
      --pro1:#f59e0b; --pro2:#fde68a;
      --ok1:#22c55e; --ok2:#60a5fa;
      --game1:#a78bfa; --game2:#f472b6;
      --brand1:#60a5fa; --brand2:#34d399;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Segoe UI,Arial; color:#fff; background:
        radial-gradient(900px 480px at 10% 10%, rgba(59,130,246,.18), transparent 40%),
        radial-gradient(900px 480px at 90% 90%, rgba(236,72,153,.14), transparent 40%),
        var(--bg);
      padding:18px;
    }
    .wrap{max-width:1180px;margin:0 auto}
    .top{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:12px 14px; border:1px solid var(--border); border-radius:var(--r);
      background:rgba(255,255,255,.04); box-shadow:var(--sh);
      position:sticky; top:12px; backdrop-filter: blur(10px); z-index:5;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(135deg,#3b82f6,#a78bfa); font-weight:900}
    .title{font-weight:900;letter-spacing:-.02em}
    .sub{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,button,textarea,input{
      font:inherit; color:#fff; background:rgba(255,255,255,.06);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px;
    }
    select{cursor:pointer}
    button{cursor:pointer; font-weight:900}
    button.primary{
      border:0; background:linear-gradient(90deg,#22c55e,#3b82f6);
      color:#07151f; padding:10px 14px;
    }
    button.warn{
      border:0; background:linear-gradient(90deg,#f59e0b,#fde68a);
      color:#111827;
    }
    button.ghost{background:transparent}
    button:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--border); border-radius:var(--r);
      background:rgba(255,255,255,.04); box-shadow:var(--sh);
      padding:14px;
    }
    h2{margin:0 0 10px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    textarea{width:100%;min-height:140px;resize:vertical}

    .packs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    @media (max-width:980px){.packs{grid-template-columns:1fr}}
    .pack{
      padding:12px; border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,.04); cursor:pointer; position:relative; overflow:hidden;
      transition: transform .08s ease;
    }
    .pack:hover{transform: translateY(-2px)}
    .pack.active{outline:2px solid rgba(255,255,255,.34)}
    .tag{
      position:absolute; top:10px; right:10px;
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      background:rgba(255,255,255,.10);
    }
    .pack.free{border-color:rgba(59,130,246,.35)}
    .pack.free .tag{background:linear-gradient(90deg,var(--free1),var(--free2))}
    .pack.inf{border-color:rgba(192,38,211,.35)}
    .pack.inf .tag{background:linear-gradient(90deg,var(--inf1),var(--inf2))}
    .pack.pro{border-color:rgba(245,158,11,.35)}
    .pack.pro .tag{background:linear-gradient(90deg,var(--pro1),var(--pro2)); color:#111827}
    .pname{font-weight:900}
    .pprice{font-size:18px;font-weight:900;margin:6px 0}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px}

    .templates{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    @media (max-width:520px){.templates{grid-template-columns:1fr}}
    .tpl{padding:10px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.03);cursor:pointer}
    .tpl b{display:block;margin-bottom:3px}

    .cards{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .card{
      border:1px solid var(--border); border-radius:14px; background:rgba(0,0,0,.24);
      padding:12px;
    }
    .cardhead{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .chip{
      font-size:12px;font-weight:900;border-radius:999px;padding:6px 10px;border:1px solid var(--border);
      background:rgba(255,255,255,.06); color:#fff;
    }
    .chip.theme-influencer{background:linear-gradient(90deg,var(--inf1),var(--inf2)); border:0}
    .chip.theme-oyun{background:linear-gradient(90deg,var(--game1),var(--game2)); border:0}
    .chip.theme-marka{background:linear-gradient(90deg,var(--brand1),var(--brand2)); border:0}
    .chip.theme-okul{background:linear-gradient(90deg,var(--ok1),var(--ok2)); border:0}
    .card pre{margin:10px 0 0 0;white-space:pre-wrap;line-height:1.35}
    .tiny{font-size:12px;color:var(--muted)}

    /* GiriÅŸ ekranÄ± */
    .overlay{
      position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(0,0,0,.55); backdrop-filter: blur(10px);
      z-index:999;
    }
    .login{
      width:min(520px, 92vw);
      border:1px solid var(--border);
      border-radius:22px;
      background:rgba(255,255,255,.06);
      box-shadow:var(--sh);
      padding:18px;
    }
    .login h1{margin:0 0 6px 0;font-size:22px}
    .login .muted{margin-bottom:12px}
    .login .row{margin-top:10px}
    .login input{width:100%}
    .kicker{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .kbadge{
      font-size:12px; font-weight:900; padding:6px 10px;
      border-radius:999px; border:1px solid var(--border);
      background:rgba(255,255,255,.06);
    }

    /* kÃ¼Ã§Ã¼k link gibi buton */
    .linkbtn{
      background:transparent; border:0; padding:0; cursor:pointer;
      color:#93c5fd; font-weight:800;
      text-decoration: underline;
    }

    /* Auth overlay visuals */
    .overlay{ background:linear-gradient(135deg, rgba(251,191,36,0.02), rgba(168,85,247,0.01)); }
    .login{ transition: transform .36s cubic-bezier(.22,.9,.3,1), box-shadow .28s ease; }
    .login:hover{ transform:translateY(-6px); box-shadow:0 30px 80px rgba(0,0,0,0.48); }
    .login h1{ font-size:24px; letter-spacing:0.02em; }
    .tiny.shimmer{ background:linear-gradient(90deg,#fbbf24,#ffd66b,#fbbf24); -webkit-background-clip:text; background-clip:text; color:transparent; animation: shimmer 3s linear infinite; background-size:200% 100%; }
    @keyframes shimmer{ 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

    /* pack card animations */
    .pack{ transition: transform .24s ease, box-shadow .24s ease; cursor:pointer; }
    .pack:hover{ transform:translateY(-6px) scale(1.01); box-shadow:0 20px 60px rgba(0,0,0,0.36); }
    .pack.active{ box-shadow:0 30px 90px rgba(59,130,246,0.08); transform:translateY(-8px) scale(1.02); border:1px solid rgba(59,130,246,0.18); }

  </style>
</head>
<body>
  <!-- GiriÅŸ ekranÄ± (localStorage ile hatÄ±rlanÄ±r) -->
  <div class="overlay" id="overlay" style="display:none">
    <div class="login">
      <div class="kicker">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="logo" style="width:44px;height:44px">S</div>
          <div>
            <div style="font-weight:900">Spark Ad Studio</div>
            <div class="tiny">Demo uygulama â€¢ n8n sonra</div>
          </div>
        </div>
        <div class="kbadge">GiriÅŸ</div>
      </div>

      <h1>HoÅŸ geldin ðŸ‘‹</h1>
      <div class="muted">AdÄ±nÄ± yaz, uygulamaya gir. (TarayÄ±cÄ±da saklanÄ±r)</div>

      <div class="row">
        <input id="nameInput" placeholder="AdÄ±n (Ã¶r: Emir)" maxlength="24" />
      </div>

      <div class="row">
        <button class="primary" id="enterBtn">Devam</button>
        <button class="ghost" id="skipBtn">Åžimdilik geÃ§</button>
        <button class="btn-quick-admin" id="btn-admin-quick" title="Admin hÄ±zlÄ± giriÅŸi demo">Admin HÄ±zlÄ± GiriÅŸ</button>
        <span class="tiny" id="loginStatus"></span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">S</div>
        <div>
          <div class="title">Spark Ad Studio</div>
          <div class="sub" id="hello">Uygulama (demo) â€” paket + ÅŸablon + geÃ§miÅŸ + export</div>
        </div>
      </div>

      <div class="actions">
        <select id="theme">
          <option value="influencer">Influencer</option>
          <option value="oyun">Oyun</option>
          <option value="marka">Marka</option>
          <option value="okul">Okul</option>
        </select>

        <select id="format">
          <option value="ad">Reklam (BaÅŸlÄ±k + AÃ§Ä±klama + CTA)</option>
          <option value="post">Sosyal Post</option>
          <option value="script">15sn Video Metni</option>
        </select>

        <button class="ghost" id="export">Export (.txt)</button>
        <button class="ghost" id="clear">GeÃ§miÅŸi Temizle</button>
        <button class="ghost" id="btn-admin-panel" style="display:none">Admin</button>
        <button class="primary" id="run">ÃœRET</button>
      </div>
    </div>

    <div class="grid">
      <!-- Sol: Girdi -->
      <div class="panel">
        <h2>Paket</h2>
        <div class="muted">
          <b>Paket kilidi:</b> Free paket bazÄ± formatlarÄ± kilitler. (Demo)
        </div>

        <div class="packs" id="packs">
          <div class="pack free active" data-pack="free" data-credit="5">
            <div class="tag">Free</div>
            <div class="pname">Free</div>
            <div class="pprice">Ãœcretsiz</div>
            <div class="pillrow"><div class="pill">5 kredi (demo)</div><div class="pill">Temel metin</div></div>
          </div>

          <div class="pack inf" data-pack="influencer" data-credit="100">
            <div class="tag">Influencer</div>
            <div class="pname">Influencer</div>
            <div class="pprice">â‚º199 / ay</div>
            <div class="pillrow"><div class="pill">100 kredi (demo)</div><div class="pill">Daha renkli</div></div>
          </div>

          <div class="pack pro" data-pack="pro" data-credit="âˆž">
            <div class="tag">Pro</div>
            <div class="pname">Pro</div>
            <div class="pprice">â‚º699 / ay</div>
            <div class="pillrow"><div class="pill">SÄ±nÄ±rsÄ±z (demo)</div><div class="pill">Daha fazla varyasyon</div></div>
          </div>
        </div>

        <h2 style="margin-top:14px">Åžablonlar (1 tÄ±kla doldur)</h2>
        <div class="templates" id="templates">
          <div class="tpl" data-text="13-14 yaÅŸa hitap eden komik bir oyun reklamÄ± yaz. Oyunun adÄ±: ____ .">
            <b>Oyun ReklamÄ±</b><div class="tiny">GenÃ§, komik, hÄ±zlÄ±</div>
          </div>
          <div class="tpl" data-text="Bir influencer iÃ§in 3 baÅŸlÄ±k + 1 kÄ±sa aÃ§Ä±klama + 1 CTA yaz. ÃœrÃ¼n: ____ .">
            <b>Influencer</b><div class="tiny">IG/TikTok tonu</div>
          </div>
          <div class="tpl" data-text="Bir marka iÃ§in profesyonel reklam metni yaz: ÃœrÃ¼n: ____ . FaydasÄ±: ____ .">
            <b>Marka</b><div class="tiny">GÃ¼ven veren</div>
          </div>
          <div class="tpl" data-text="Okul etkinliÄŸi duyurusu yaz: Etkinlik: ____ . Tarih: ____ . Yer: ____ .">
            <b>Okul</b><div class="tiny">Resmi & net</div>
          </div>
        </div>

        <h2 style="margin-top:14px">Fikrini yaz</h2>
        <textarea id="prompt" placeholder="Fikrini buraya yaz..."></textarea>

        <div class="row" style="margin-top:10px">
          <div class="muted" id="status">HazÄ±r.</div>
          <button class="warn" id="unlockTip" style="display:none">ðŸ”’ Kilit var (bak)</button>
        </div>

        <div class="tiny" style="margin-top:8px">
          Ä°pucu: Free pakette <b>Video Metni</b> kilitli. Influencer/Pro ile aÃ§Ä±lÄ±r.
          <button class="linkbtn" id="whoAmI">AdÄ±mÄ± deÄŸiÅŸtir</button>
        </div>
      </div>

      <!-- SaÄŸ: Ã‡Ä±ktÄ± + GeÃ§miÅŸ -->
      <div class="panel">
        <h2>Ãœretilenler (GeÃ§miÅŸ)</h2>
        <div class="muted">Ãœrettiklerin kart kart burada kalÄ±r. (TarayÄ±cÄ±da saklanÄ±r)</div>
        <div class="cards" id="cards"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // --- LocalStorage key'leri ---
  const LS_KEY = "sparkad_history_v2";
  const LS_STATE = "sparkad_state_v2";
  const LS_NAME = "sparkad_user_name_v1";

  // --- KullanÄ±cÄ± (giriÅŸ ekranÄ±) ---
  function getCurrentUser(){
    try{ return JSON.parse(localStorage.getItem('sparkad_user_v1')) || null; }catch(e){ return null; }
  }
  function setCurrentUser(u){
    if(!u){ localStorage.removeItem('sparkad_user_v1'); localStorage.removeItem(LS_NAME); }
    else { localStorage.setItem('sparkad_user_v1', JSON.stringify(u)); localStorage.setItem(LS_NAME, u.name||""); }
    updateHello();
    // toggle admin button visibility
    try{ const adminBtn = $("btn-admin-panel"); if(adminBtn) adminBtn.style.display = (u && u.role && String(u.role).toLowerCase()==='admin') ? 'inline-flex' : 'none'; }catch(e){}
  }

  function getName(){
    const u = getCurrentUser();
    if(u && u.name) return (u.name||"").trim();
    return (localStorage.getItem(LS_NAME) || "").trim();
  }

  function updateHello(){
    const u = getCurrentUser();
    const n = u && u.name ? u.name : getName();
    $("hello").textContent = n ? `Selam ${n} ${u && u.role && u.role==='admin' ? '(Admin)' : ''} ðŸ‘‹ â€¢ demo: paket + ÅŸablon + geÃ§miÅŸ + export` : `Uygulama (demo) â€” paket + ÅŸablon + geÃ§miÅŸ + export`;
  }

  function openLogin(){
    $("overlay").style.display = "grid";
    $("nameInput").value = getName();
    $("nameInput").focus();
  }
  function closeLogin(){
    $("overlay").style.display = "none";
    updateHello();
  }

  // giriÅŸ ilk aÃ§Ä±lÄ±ÅŸ
  window.addEventListener("load", () => {
    updateHello();
    const cu = getCurrentUser();
    if(!cu || !cu.name){
      $("overlay").style.display = "grid";
    }
    // ensure admin panel button state
    try{ const adminBtn = $("btn-admin-panel"); if(adminBtn) adminBtn.style.display = (cu && cu.role && String(cu.role).toLowerCase()==='admin') ? 'inline-flex' : 'none'; }catch(e){}
  });

  $("enterBtn").addEventListener("click", () => {
    const v = $("nameInput").value.trim();
    if(!v){
      $("loginStatus").textContent = "Ad yaz veya Åžimdilik geÃ§.";
      return;
    }
    setCurrentUser({ name: v, role: 'user' });
    $("loginStatus").textContent = "";
    // success flash
    try{ document.body.classList.add('auth-success'); setTimeout(()=>document.body.classList.remove('auth-success'),900); }catch(e){}
    closeLogin();
  });
  $("skipBtn").addEventListener("click", () => {
    setCurrentUser(null); // boÅŸ bÄ±rak
    closeLogin();
  });
  $("whoAmI").addEventListener("click", () => openLogin());

  // Admin quick-login
  try{ const btnAdminQuick = document.getElementById('btn-admin-quick'); if(btnAdminQuick){ btnAdminQuick.addEventListener('click', ()=>{ setCurrentUser({ name: 'YÃ¶netici', role: 'admin' }); $("loginStatus").textContent = 'YÃ¶netici olarak giriÅŸ yapÄ±ldÄ±.'; try{ document.body.classList.add('auth-success'); setTimeout(()=>document.body.classList.remove('auth-success'),900); }catch(e){} closeLogin(); }); } }catch(e){}

  // Admin panel demo
  try{ const btnAdminPanel = document.getElementById('btn-admin-panel'); if(btnAdminPanel){ btnAdminPanel.addEventListener('click', ()=>{ alert('YÃ¶netici paneli (demo): Ãœyeler, Kredi, Paketler yÃ¶netim bÃ¶lÃ¼mÃ¼.'); }); } }catch(e){}

  // --- Paket seÃ§imi + kredi ---
  let selectedPack = "free";
  let creditsLeft = 5;

  const packEls = [...document.querySelectorAll(".pack")];
  function setPack(el){
    packEls.forEach(x => x.classList.remove("active"));
    el.classList.add("active");
    selectedPack = el.dataset.pack;
    creditsLeft = el.dataset.credit === "âˆž" ? Infinity : Number(el.dataset.credit);
    $("status").textContent = `Paket: ${selectedPack} â€¢ Kredi: ${creditsLeft === Infinity ? "SÄ±nÄ±rsÄ±z" : creditsLeft}`;
    enforceLocks();
    saveState();
  }
  packEls.forEach(el => el.addEventListener("click", () => setPack(el)));

  // --- Åžablon tÄ±klayÄ±nca textarea doldur ---
  [...document.querySelectorAll(".tpl")].forEach(tpl => {
    tpl.addEventListener("click", () => {
      $("prompt").value = tpl.dataset.text;
      $("prompt").focus();
    });
  });

  // --- Tema chip class ---
  function themeClass(theme){ return "theme-" + theme; }

  // --- Paket kilidi kurallarÄ± ---
  function isLocked(format){
    // Free: script kilitli, post aÃ§Ä±k, ad aÃ§Ä±k
    if(selectedPack === "free" && format === "script") return true;
    // Influencer: her ÅŸey aÃ§Ä±k
    // Pro: her ÅŸey aÃ§Ä±k
    return false;
  }
  function enforceLocks(){
    const format = $("format").value;
    const locked = isLocked(format);
    $("unlockTip").style.display = locked ? "inline-block" : "none";
    if(locked){
      $("status").textContent = "ðŸ”’ Bu format Free pakette kilitli. Influencer/Pro seÃ§.";
    }else{
      $("status").textContent = `Paket: ${selectedPack} â€¢ Kredi: ${creditsLeft === Infinity ? "SÄ±nÄ±rsÄ±z" : creditsLeft}`;
    }
  }
  $("format").addEventListener("change", enforceLocks);
  $("unlockTip").addEventListener("click", () => {
    alert("Free pakette 15sn Video Metni kilitli.\nÃ‡Ã¶zÃ¼m: Influencer veya Pro seÃ§.");
  });

  // --- Demo Ã¼retici: paket + tema + format etkisi ---
  function demoGenerate({prompt, theme, format, pack}){
    const name = getName();
    const hi = name ? `${name}, ` : "";

    const tone =
      theme === "oyun" ? "Hype + komik genÃ§ dili" :
      theme === "influencer" ? "IG/TikTok enerjik dili" :
      theme === "marka" ? "GÃ¼ven veren profesyonel" : "Okul/kulÃ¼p resmi dili";

    const extra =
      pack === "free" ? " (temel)" :
      pack === "influencer" ? " (daha renkli + daha net)" :
      " (daha fazla varyasyon + daha gÃ¼Ã§lÃ¼)";

    const varyCount = (pack === "pro") ? 3 : (pack === "influencer" ? 2 : 1);

    if(format === "ad"){
      const titles = [];
      for(let i=0;i<varyCount;i++){
        titles.push(`- ${prompt.replace("____","").slice(0,70)} â€” ÅŸimdi keÅŸfet!`);
      }
      return `${hi}iÅŸte reklamÄ±n!\n\nðŸŽ¯ Tema: ${theme} (${tone})\nðŸ“¦ Paket: ${pack}${extra}\n\n1) BaÅŸlÄ±k Ã–nerileri:\n${titles.join("\n")}\n\n2) AÃ§Ä±klama:\n${prompt}\n\n3) CTA:\nHemen dene â€¢ PaylaÅŸ â€¢ Kaydet`;
    }

    if(format === "post"){
      const hashtags = theme === "oyun" ? "#oyun #gamer #viral" :
                       theme === "influencer" ? "#reels #tiktok #trend" :
                       theme === "marka" ? "#marka #kampanya #urun" : "#okul #duyuru #etkinlik";
      return `${hi}hazÄ±r post:\n\n${prompt}\n\nðŸ”¥ Ton: ${tone}${extra}\n\n${hashtags} #sparkadstudio`;
    }

    // script
    return `${hi}15sn video metni:\n\nTema: ${theme} â€¢ Paket: ${pack}${extra}\n\nSahne 1 (0-5sn): â€œ${prompt}â€\nSahne 2 (5-12sn): 2 vurucu fayda + hÄ±zlÄ± tempo\nSahne 3 (12-15sn): â€œHemen dene!â€`;
  }

  // --- GeÃ§miÅŸ (localStorage) ---
  function loadHistory(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch { return []; }
  }
  function saveHistory(items){ localStorage.setItem(LS_KEY, JSON.stringify(items)); }

  function loadState(){
    try { return JSON.parse(localStorage.getItem(LS_STATE) || "{}"); }
    catch { return {}; }
  }
  function saveState(){
    localStorage.setItem(LS_STATE, JSON.stringify({
      selectedPack,
      theme: $("theme").value,
      format: $("format").value,
      creditsLeft: creditsLeft === Infinity ? "âˆž" : creditsLeft
    }));
  }

  function render(){
    const items = loadHistory();
    const cards = $("cards");
    cards.innerHTML = "";

    if(items.length === 0){
      cards.innerHTML = `<div class="muted">HenÃ¼z Ã¼retim yok. Soldan fikir yazÄ±p ÃœRETâ€™e bas.</div>`;
      return;
    }

    for(const it of items){
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="cardhead">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <span class="chip ${themeClass(it.theme)}">${it.theme}</span>
            <span class="chip">${it.pack}</span>
            <span class="chip">${it.format}</span>
          </div>
          <div class="tiny">${new Date(it.ts).toLocaleString("tr-TR")}</div>
        </div>
        <pre>${escapeHtml(it.text)}</pre>
      `;
      cards.appendChild(el);
    }
  }

  function escapeHtml(s){
    return (s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  // --- GeÃ§miÅŸ temizle ---
  $("clear").addEventListener("click", () => {
    if(!confirm("GeÃ§miÅŸ temizlensin mi?")) return;
    saveHistory([]);
    render();
  });

  // --- Export (.txt) ---
  $("export").addEventListener("click", () => {
    const items = loadHistory();
    if(items.length === 0) return alert("Export iÃ§in Ã¶nce bir ÅŸey Ã¼ret ðŸ™‚");

    let text = `Spark Ad Studio Export\n`;
    const name = getName();
    if(name) text += `KullanÄ±cÄ±: ${name}\n`;
    text += `Tarih: ${new Date().toLocaleString("tr-TR")}\n`;
    text += `\n====================\n\n`;

    for(const it of items){
      text += `[${new Date(it.ts).toLocaleString("tr-TR")}] Tema:${it.theme} â€¢ Paket:${it.pack} â€¢ Format:${it.format}\n`;
      text += `${it.text}\n`;
      text += `\n--------------------\n\n`;
    }

    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "sparkad-export.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // --- ÃœRET ---
  $("run").addEventListener("click", async () => {
    const prompt = $("prompt").value.trim();
    if(!prompt) return alert("Ã–nce bir fikir yaz ðŸ™‚");

    const theme = $("theme").value;
    const format = $("format").value;

    // kilit kontrol
    if(isLocked(format)){
      $("status").textContent = "ðŸ”’ Bu format Free pakette kilitli. Influencer/Pro seÃ§.";
      $("unlockTip").style.display = "inline-block";
      return;
    }

    if(creditsLeft !== Infinity && creditsLeft <= 0){
      $("status").textContent = "âŒ Kredi bitti (demo). Paket deÄŸiÅŸtir ya da yarÄ±n dene.";
      return;
    }

    $("run").disabled = true;
    $("status").textContent = "Ãœretiliyor...";

    // Demo Ã¼retim
    const result = demoGenerate({prompt, theme, format, pack: selectedPack});

    if(creditsLeft !== Infinity) creditsLeft -= 1;

    const items = loadHistory();
    items.unshift({ ts: Date.now(), theme, format, pack: selectedPack, text: result });
    saveHistory(items.slice(0, 25)); // en son 25 kayÄ±t

    saveState();
    render();

    $("status").textContent = `Bitti âœ… â€¢ Kalan kredi: ${creditsLeft === Infinity ? "SÄ±nÄ±rsÄ±z" : creditsLeft}`;
    $("run").disabled = false;
  });

  // --- BaÅŸlangÄ±Ã§ state ---
  (function init(){
    const st = loadState();
    if(st.theme) $("theme").value = st.theme;
    if(st.format) $("format").value = st.format;

    if(st.selectedPack){
      const el = packEls.find(x => x.dataset.pack === st.selectedPack);
      if(el) setPack(el);
    }else{
      $("status").textContent = `Paket: ${selectedPack} â€¢ Kredi: ${creditsLeft}`;
    }

    enforceLocks();
    render();
    updateHello();
  })();
</script>
</body>
</html>
